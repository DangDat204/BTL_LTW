<!DOCTYPE html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Trọ Sinh Viên Giá Rẻ</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
			display: flex;
			flex-direction: column;
		}

		.container {
			flex: 1;
		}

		body {
			background: linear-gradient(to bottom, #f8f9fa, #ffffff);
		}


		.hero-section {
			background: linear-gradient(to right, #8b9094, #adb5bd);
			color: white;
			padding: 40px 0;
		}

		.filter-section {
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0px 0px 10px rgba(150, 218, 161, 0.1);
		}

		.card {
			transition: transform 0.3s ease-in-out;
		}

		.card:hover {
			transform: scale(1.05);
		}

	</style>
</head>

<body>

	<div id="navbar-placeholder"></div>

	<!-- Nội dung chính -->
	<div id="main-content">
		<!-- Carousel -->
		<div id="carouselExampleDark" class="carousel carousel-dark slide" data-bs-ride="carousel">
			<div class="carousel-indicators">
				<button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="0" class="active"
					aria-current="true" aria-label="Slide 1"></button>
				<button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="1" aria-label="Slide 2"></button>
				<button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="2" aria-label="Slide 3"></button>
				<button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="3" aria-label="Slide 4"></button>
			</div>
			<div class="carousel-inner">
				<div class="carousel-item active" data-bs-interval="10000">
					<img src="https://pdca.vn/uploads/images/bai-viet/mo-hinh-kinh-doanh-cho-thue11-1-.jpg" class="d-block w-100"
						alt="..." height="480">
					<div class="carousel-caption d-none d-md-block">
						<h5>First slide label</h5>
						<p>Some representative placeholder content for the first slide.</p>
					</div>
				</div>
				<div class="carousel-item" data-bs-interval="2000">
					<img src="https://static1.cafeland.vn/cafelandnew/hinh-anh/2021/02/17/141/image-20210217132812-2.jpeg"
						class="d-block w-100" alt="..." height="480">
					<div class="carousel-caption d-none d-md-block">
						<h5>Second slide label</h5>
						<p>Some representative placeholder content for the second slide.</p>
					</div>
				</div>
				<div class="carousel-item">
					<img src="https://tl.cdnchinhphu.vn/344445545208135680/2024/4/19/sleep-box-1-17134898300182062579973.jpg"
						class="d-block w-100" alt="..." height="480">
					<div class="carousel-caption d-none d-md-block">
						<h5>Third slide label</h5>
						<p>Some representative placeholder content for the third slide.</p>
					</div>
				</div>
				<div class="carousel-item">
					<img src="https://s-housing.vn/wp-content/uploads/2022/09/thiet-ke-phong-tro-dep-7.jpg" class="d-block w-100"
						alt="..." height="480">
					<div class="carousel-caption d-none d-md-block">
						<h5>Four slide label</h5>
						<p>Some representative placeholder content for the fourth slide.</p>
					</div>
				</div>
			</div>
			<button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="prev">
				<span class="carousel-control-prev-icon" aria-hidden="true"></span>
				<span class="visually-hidden">Previous</span>
			</button>
			<button class="carousel-control-next" type="button" data-bs-target="#carouselExampleDark" data-bs-slide="next">
				<span class="carousel-control-next-icon" aria-hidden="true"></span>
				<span class="visually-hidden">Next</span>
			</button>
		</div>


		<div class="container mt-4">
			<div class="row">
				<div class="col-md-4 filter-section">
					<h5>Bộ lọc</h5>
					<select id="priceFilter" class="form-select mb-3">
						<option selected>Giá (triệu/tháng)</option>
						<option value="1">Dưới 2 triệu</option>
						<option value="2">2 - 3 triệu</option>
						<option value="3">Trên 3 triệu</option>
					</select>
					<!--            Cầu Giấy, Thanh Xuân, Hoàng Mai, Đống Đa, Hà Đông, Hai Bà Trưng, Ba Đình, Hoàn Kiếm, Long Biên, Tây Hồ, Nam Từ Liêm và Bắc Từ Liêm-->
					<select id="addressFilter" class="form-select mb-3">
						<option value="">Chọn địa chỉ</option>
						<option value="Cầu Giấy">Cầu Giấy</option>
						<option value="Thanh Xuân">Thanh Xuân</option>
						<option value="Hoàng Mai">Hoàng Mai</option>
						<option value="Đống Đa">Đống Đa</option>
						<option value="Hà Đông">Hà Đông</option>
						<option value="Hai Bà Trưng">Hai Bà Trưng</option>
						<option value="Ba Đình">Ba Đình</option>
						<option value="Hoàn Kiếm">Hoàn Kiếm</option>
						<option value="Long Biên">Long Biên</option>
						<option value="Tây Hồ">Tây Hồ</option>
						<option value="Nam Từ Liêm">Nam Từ Liêm</option>
						<option value="Bắc Từ Liêm">Bắc Từ Liêm</option>
					</select>
					<select id="areaFilter" class="form-select mb-3">
						<option selected>Diện tích (m²)</option>
						<option value="1">Dưới 20m²</option>
						<option value="2">20 - 30m²</option>
						<option value="3">30 - 40m²</option>
						<option value="4">Trên 40m²</option>
					</select>
					<select id="typeFilter" class="form-select mb-3">
						<option selected>Kiểu phòng</option>
						<option value="1">Phòng Studio</option>
						<option value="2">Phòng căn hộ</option>
						<option value="3">Phòng đôi</option>
					</select>
					<button id="filterButton" class="btn btn-success w-100">Lọc kết quả</button>
					<button id="resetButton" class="btn btn-secondary w-100 mt-2">Xóa bộ lọc</button>

				</div>
				<div class="col-md-8">
					<h3 class="text-center mb-4">Danh sách phòng trọ</h3>
					<div id="room-container" class="row"></div>

					<!-- Phân trang -->
					<nav class="mt-4">
						<ul id="pagination" class="pagination justify-content-center"></ul>
					</nav>
					<h3 class="mt-4">Tin tức</h3>
					<ul class="list-group">
						<li class="list-group-item">Những lưu ý khi thuê trọ</li>
						<li class="list-group-item">Vấn nạn an toàn PCCC tại các nhà trọ</li>
					</ul>
				</div>
			</div>
		</div>
	</div>

	<div id="footer-placeholder"></div>

	<script>
		// Nhúng navbar
		fetch('/navbar.html')
			.then(res => res.text())
			.then(data => {
				document.getElementById('navbar-placeholder').innerHTML = data;
				if (window.handleNavbarRole) window.handleNavbarRole();
			});

		// Nhúng footer
		fetch('/footer.html')
			.then(res => res.text())
			.then(data => {
				document.getElementById('footer-placeholder').innerHTML = data;
			});

		// --- Các biến và hàm chỉ liên quan đến hiển thị/phân trang/phòng ---
		const pageSize = 4;
		let currentPage = 1;
		let isFiltering = false;
		let currentFilterParams = "";

		const apiBaseUrl = {
			getAll: "http://localhost:8080/rooms/getAllRooms",
			filter: "http://localhost:8080/rooms/filterRooms"
		};

		function fetchRooms(page) {
			const rawToken = localStorage.getItem("jwtToken");
			if (!rawToken) {
				alert("Bạn chưa đăng nhập!");
				return;
			}

			const token = rawToken.startsWith("Bearer ") ? rawToken : "Bearer " + rawToken;

			const url = isFiltering
				? `${apiBaseUrl.filter}${currentFilterParams}&pageNumber=${page}&pageSize=${pageSize}`
				: `${apiBaseUrl.getAll}?pageNumber=${page}&pageSize=${pageSize}`;

			fetch(url, {
				method: "GET",
				headers: {
					"Content-Type": "application/json",
					"Authorization": token
				}
			})
				.then(res => {
					if (!res.ok) throw new Error("Lỗi khi gọi API");
					return res.json();
				})
				.then(data => {
					const rooms = isFiltering ? data.result.FilterRooms : data.result.rooms;
					displayRooms(rooms);
					setupPagination(data.result.totalPages, data.result.currentPage);
				})
				.catch(error => {
					console.error("Lỗi khi fetchRooms:", error);
				});
		}

		function displayRooms(rooms) {
			const container = document.getElementById("room-container");
			container.innerHTML = "";

			if (!rooms || rooms.length === 0) {
				container.innerHTML = "<p class='text-danger'>Không có phòng nào phù hợp!</p>";
				return;
			}

			rooms.forEach(room => {
				const image = room.images[0]?.url || "https://via.placeholder.com/300x200";
				const div = document.createElement("div");
				div.className = "col-md-6 mb-4";

				div.innerHTML = `
				  <div class="card h-100 shadow-sm">
					<img src="${image}" class="card-img-top" alt="Ảnh phòng" style="height: 200px; object-fit: cover;">
					<div class="card-body">
					  <h5 class="card-title">Địa chỉ phòng trọ: ${room.address}</h5>
					  <p class="card-text">ID phòng: ${room.id}</p>
					  <p class="card-text">Mô tả: ${room.description}</p>
					  <p class="card-text">Loại phòng: ${room.roomType}</p>
					  <a href="#" class="btn btn-success" onclick="showRoomDetail(${room.id}); return false;">Xem chi tiết</a>
					</div>
				  </div>
				`;
				container.appendChild(div);
			});
		}

		function setupPagination(totalPages, current) {
			const pagination = document.getElementById("pagination");
			pagination.innerHTML = "";

			for (let i = 1; i <= totalPages; i++) {
				const li = document.createElement("li");
				li.className = "page-item" + (i === current ? " active" : "");
				li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
				li.addEventListener("click", (e) => {
					e.preventDefault();
					currentPage = i;
					fetchRooms(currentPage);
				});
				pagination.appendChild(li);
			}
		}

		// Lọc phòng
		document.getElementById("filterButton").addEventListener("click", () => {
			const rawToken = localStorage.getItem("jwtToken");
			if (!rawToken) {
				alert("Bạn chưa đăng nhập!");
				return;
			}

			// Lấy giá trị từ form lọc
			const priceValue = document.getElementById("priceFilter").value;
			const areaValue = document.getElementById("areaFilter").value;
			const typeValue = document.getElementById("typeFilter").value;
			const addressValue = document.getElementById("addressFilter").value.trim();

			// Xử lý khoảng giá
			let minPrice = "", maxPrice = "";
			if (priceValue === "1") maxPrice = 2;
			else if (priceValue === "2") { minPrice = 2; maxPrice = 3; }
			else if (priceValue === "3") minPrice = 3;

			// Xử lý diện tích
			let minArea = "", maxArea = "";
			if (areaValue === "1") maxArea = 20;
			else if (areaValue === "2") { minArea = 20; maxArea = 30; }
			else if (areaValue === "3") { minArea = 30; maxArea = 40; }
			else if (areaValue === "4") minArea = 40;

			// Loại phòng
			const roomType = typeValue === "1" ? "STUDIO"
				: typeValue === "2" ? "APARTMENT"
					: typeValue === "3" ? "SHARED"
						: "";

			// Kiểm tra address: bỏ qua nếu là "-- Chọn địa chỉ --" hoặc rỗng
			const address = (addressValue && addressValue !== "Chọn địa chỉ") ? addressValue : "";

			// Tạo query string
			currentFilterParams =
				`?minPrice=${minPrice}&maxPrice=${maxPrice}` +
				`&minArea=${minArea}&maxArea=${maxArea}` +
				`&address=${encodeURIComponent(address)}` +
				`&roomType=${roomType}`;

			isFiltering = true;
			currentPage = 1;
			fetchRooms(currentPage);
		});

		// Reset bộ lọc
		document.getElementById("resetButton").addEventListener("click", () => {
			document.getElementById("priceFilter").selectedIndex = 0;
			document.getElementById("addressFilter").selectedIndex = 0;
			document.getElementById("areaFilter").selectedIndex = 0;
			document.getElementById("typeFilter").selectedIndex = 0;

			isFiltering = false;
			currentFilterParams = "";
			currentPage = 1;
			fetchRooms(currentPage);
		});

		// Load mặc định khi mở trang
		fetchRooms(currentPage);

		// Chi tiết phòng
		window.showRoomDetail = function(roomId) {
			const token = localStorage.getItem('jwtToken');
			if (!token) {
				alert('Bạn chưa đăng nhập!');
				return;
			}
			// Lấy dữ liệu phòng từ API
			fetch(`http://localhost:8080/rooms/${roomId}`, {
				method: 'GET',
				headers: {
					'Authorization': 'Bearer ' + token,
					'Content-Type': 'application/json'
				}
			})
				.then(res => res.json())
				.then(data => {
					const room = data.result;
					// Lấy template HTML
					fetch('/room-detail.html')
						.then(res => res.text())
						.then(html => {
							// Xử lý ảnh cho carousel
							let carouselIndicators = '';
							let carouselItems = '';
							if (room.images && room.images.length > 0) {
								room.images.forEach((img, idx) => {
									carouselIndicators += `
										<button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="${idx}" class="${idx === 0 ? 'active' : ''}" aria-current="${idx === 0 ? 'true' : 'false'}" aria-label="Slide ${idx + 1}"></button>
									`;
									carouselItems += `
									<div class="carousel-item${idx === 0 ? ' active' : ''}">
										<img src="${img.url}" class="d-block" alt="...">
									</div>
									`;
								});
							} else {
								carouselIndicators = `<button type="button" data-bs-target="#carouselExampleDark" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>`;
								carouselItems = `<div class="carousel-item active"><img src="https://via.placeholder.com/400x250" class="d-block" alt="..."></div>`;
							}
							// Thay thế các placeholder
							html = html.replace('{{carouselIndicators}}', carouselIndicators)
								.replace('{{carouselItems}}', carouselItems)
								.replace(/{{id}}/g, room.id)
								.replace(/{{address}}/g, room.address)
								.replace(/{{area}}/g, room.area)
								.replace(/{{capacity}}/g, room.capacity)
								.replace(/{{description}}/g, room.description)
								.replace(/{{price}}/g, room.price)
								.replace(/{{roomType}}/g, room.roomType)
								.replace(/{{amenities}}/g, room.amenities)
								.replace(/{{landlordTel}}/g, room.landlordTel)
								.replace(/{{landlordEmail}}/g, room.landlordEmail);
							// Gán vào main-content
							document.getElementById('main-content').innerHTML = html;
							// Kích hoạt lại carousel
							var carousel = new bootstrap.Carousel(document.getElementById('carouselExampleDark'));
							// Gán lại sự kiện cho modal đặt lịch hẹn
							var btnBook = document.querySelector('.btn-book');
							var closeModalBtn = document.getElementById('closeModal');
							var appointmentModal = document.getElementById('appointmentModal');
							var appointmentForm = document.getElementById('appointmentForm');
							if (btnBook && closeModalBtn && appointmentModal && appointmentForm) {
								btnBook.onclick = function () {
									appointmentModal.style.display = 'flex';
								};
								closeModalBtn.onclick = function () {
									appointmentModal.style.display = 'none';
								};
								appointmentForm.onsubmit = async function (e) {
									e.preventDefault();
									const comeDate = document.getElementById('comeDate').value;
									const note = document.getElementById('note').value;
									const roomId = document.getElementById('roomIdSpan').textContent.trim();
									const token = localStorage.getItem('jwtToken');
									const res = await fetch('/appointments/createAppointment', {
										method: 'POST',
										headers: {
											'Content-Type': 'application/json',
											'Authorization': 'Bearer ' + token
										},
										body: JSON.stringify({
											roomId: roomId,
											comeDate: comeDate,
											note: note
										})
									});
									const data = await res.json();
									if (data.code === 1000) {
										alert('Đặt lịch thành công!');
										appointmentModal.style.display = 'none';
									} else {
										alert('Có lỗi xảy ra: ' + data.message);
									}
								};
							}
						});
				});
		};
	</script>
	<script src="/js/common.js"></script>
</body>

</html>